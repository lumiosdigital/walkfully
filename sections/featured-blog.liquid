<div
  class="
    stories-section
    color-{{ section.settings.color_scheme }}
    {% render 'section-classes', settings: section.settings -%}
  "
  {% if section.settings.enable_animations %}
    data-animate-elements-on-scroll
    data-animate-delay="125"
  {% endif %}
>
  <div class="stories-section__container page-width">
    <div class="stories-header {% if section.settings.enable_animations %}animate animate--slide-in{% endif %}">
      {%- if section.settings.stories_accent_text != blank -%}
        <p class="stories-header__accent">{{ section.settings.stories_accent_text }}</p>
      {%- endif -%}
      {%- if section.settings.stories_heading_text != blank -%}
        <h2 class="stories-header__title">{{ section.settings.stories_heading_text }}</h2>
      {%- endif -%}
    </div>

    <div class="stories-carousel">
      <component-slider
        class="stories-carousel__slider swiper"
        data-mobile-columns="1"
        data-tablet-columns="3"
        data-desktop-columns="5"
        data-enable-loop="true"
        style="
          --mobile-columns: 1;
          --tablet-columns: 3;
          --desktop-columns: 5;
        "
      >
        <div class="stories-carousel__wrapper swiper-wrapper">
          {% for block in section.blocks %}
            {% if block.type == 'story_card' %}
              <div class="stories-carousel__slide swiper-slide" {{ block.shopify_attributes }}>
                {% render 'story-card',
                  image: block.settings.image,
                  name: block.settings.name,
                  location: block.settings.location,
                  quote: block.settings.quote,
                  link: block.settings.link,
                  animate: section.settings.enable_animations
                %}
              </div>
            {% endif %}
          {% endfor %}
        </div>

        <button type="button" class="stories-carousel__nav stories-carousel__nav--prev swiper-button-prev" aria-label="{{ 'general.slider.previous_slide' | t }}">
          <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" fill="none">
            <rect x="-0.5" y="0.5" width="29" height="29" rx="14.5" transform="matrix(-1 0 0 1 29 0)" stroke="#21262F" stroke-opacity="0.3"/>
            <path opacity="0.3" d="M21 15H9M9 15L15 9M9 15L15 21" stroke="#21262F"/>
          </svg>
        </button>
        <button type="button" class="stories-carousel__nav stories-carousel__nav--next swiper-button-next" aria-label="{{ 'general.slider.next_slide' | t }}">
          <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" fill="none">
            <rect x="0.5" y="0.5" width="29" height="29" rx="14.5" stroke="#21262F" stroke-opacity="0.3"/>
            <path opacity="0.3" d="M10 15H20M20 15L15 10M20 15L15 20" stroke="#21262F"/>
          </svg>
        </button>
      </component-slider>

      <div class="stories-footer">
        <div class="stories-footer__track">
          <div class="stories-footer__line"></div>
        </div>
        <div class="stories-footer__nav">
          <button type="button" class="stories-footer__btn stories-footer__btn--prev" aria-label="{{ 'general.slider.previous_slide' | t }}">
            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" fill="none">
              <rect x="-0.5" y="0.5" width="29" height="29" rx="14.5" transform="matrix(-1 0 0 1 29 0)" stroke="#21262F" stroke-opacity="0.3"/>
              <path opacity="0.3" d="M21 15H9M9 15L15 9M9 15L15 21" stroke="#21262F"/>
            </svg>
          </button>
          <button type="button" class="stories-footer__btn stories-footer__btn--next" aria-label="{{ 'general.slider.next_slide' | t }}">
            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" fill="none">
              <rect x="0.5" y="0.5" width="29" height="29" rx="14.5" stroke="#21262F" stroke-opacity="0.3"/>
              <path opacity="0.3" d="M10 15H20M20 15L15 10M20 15L15 20" stroke="#21262F"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const section = document.querySelector('.stories-section');
    if (!section) return;

    const prevBtn = section.querySelector('.stories-footer__btn--prev');
    const nextBtn = section.querySelector('.stories-footer__btn--next');
    const progressLine = section.querySelector('.stories-footer__line');
    const track = section.querySelector('.stories-footer__track');
    const slider = section.querySelector('component-slider');

    let currentIndex = 0;
    let totalSlides = 0;

    // Update progress line position
    function updateProgress() {
      if (!progressLine || !track || totalSlides === 0) return;
      const progress = totalSlides > 1 ? currentIndex / (totalSlides - 1) : 0;
      const trackWidth = track.offsetWidth;
      const lineWidth = progressLine.offsetWidth;
      const maxTranslate = trackWidth - lineWidth;
      const translateX = progress * maxTranslate;
      progressLine.style.transform = `translateX(${translateX}px)`;
    }

    // Navigate to next slide (with loop)
    function goNext() {
      if (!slider || !slider.swiper) return;
      slider.swiper.slideNext();
    }

    // Navigate to previous slide (with loop)
    function goPrev() {
      if (!slider || !slider.swiper) return;
      slider.swiper.slidePrev();
    }

    // Set up button listeners
    if (prevBtn) {
      prevBtn.addEventListener('click', goPrev);
    }
    if (nextBtn) {
      nextBtn.addEventListener('click', goNext);
    }

    // Wait for swiper to initialize
    const checkSwiper = setInterval(() => {
      if (slider && slider.swiper) {
        clearInterval(checkSwiper);
        // Count original slides only (not Swiper's loop duplicates)
        const originalSlides = section.querySelectorAll('.stories-carousel__slide');
        totalSlides = originalSlides.length;
        currentIndex = slider.swiper.realIndex || 0;

        // Get visible slides count from Swiper
        const visibleSlides = Math.floor(slider.swiper.params.slidesPerView);

        // Disable navigation if all slides are visible
        if (totalSlides <= visibleSlides) {
          if (prevBtn) {
            prevBtn.disabled = true;
            prevBtn.style.opacity = '0.3';
            prevBtn.style.cursor = 'default';
          }
          if (nextBtn) {
            nextBtn.disabled = true;
            nextBtn.style.opacity = '0.3';
            nextBtn.style.cursor = 'default';
          }
        }

        // Listen for slide changes (e.g., from touch/drag)
        slider.swiper.on('slideChange', () => {
          currentIndex = slider.swiper.realIndex || 0;
          updateProgress();
        });

        updateProgress();
      }
    }, 100);

    // Clear interval after 5 seconds to prevent infinite loop
    setTimeout(() => clearInterval(checkSwiper), 5000);
  });
</script>

{% schema %}
{
  "name": "Stories carousel",
  "class": "stories-section-wrapper",
  "tag": "section",
  "disabled_on": {
    "groups": [
      "header",
      "footer"
    ],
    "templates": [
      "password"
    ]
  },
  "settings": [
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:sections.all.colors.label",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "Header"
    },
    {
      "type": "text",
      "id": "stories_accent_text",
      "label": "Accent text",
      "default": "Stories"
    },
    {
      "type": "text",
      "id": "stories_heading_text",
      "label": "Heading text",
      "default": "FROM THE WALK"
    },
    {
      "type": "header",
      "content": "t:common.header__section_spacing_and_border.content"
    },
    {
      "type": "select",
      "id": "section_spacing_top",
      "label": "t:common.top_spacing.label",
      "options": [
        {
          "value": "none",
          "label": "t:common.sizing.none"
        },
        {
          "value": "compact",
          "label": "t:common.sizing.compact"
        },
        {
          "value": "standard",
          "label": "t:common.sizing.standard"
        },
        {
          "value": "large",
          "label": "t:common.sizing.large"
        },
        {
          "value": "x-large",
          "label": "t:common.sizing.x_large"
        },
        {
          "value": "2x-large",
          "label": "t:common.sizing.x_x_large"
        }
      ],
      "default": "x-large"
    },
    {
      "type": "select",
      "id": "section_spacing_bottom",
      "label": "t:common.bottom_spacing.label",
      "options": [
        {
          "value": "none",
          "label": "t:common.sizing.none"
        },
        {
          "value": "compact",
          "label": "t:common.sizing.compact"
        },
        {
          "value": "standard",
          "label": "t:common.sizing.standard"
        },
        {
          "value": "large",
          "label": "t:common.sizing.large"
        },
        {
          "value": "x-large",
          "label": "t:common.sizing.x_large"
        },
        {
          "value": "2x-large",
          "label": "t:common.sizing.x_x_large"
        }
      ],
      "default": "x-large"
    },
    {
      "type": "checkbox",
      "id": "show_bottom_border",
      "label": "t:common.show_bottom_border.label",
      "default": false
    },
    {
      "type": "header",
      "content": "t:common.header__section_animations.content"
    },
    {
      "type": "checkbox",
      "id": "enable_animations",
      "label": "t:common.enable_animations.label",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "story_card",
      "name": "Story card",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "text",
          "id": "name",
          "label": "Name",
          "default": "Name"
        },
        {
          "type": "text",
          "id": "location",
          "label": "Location",
          "default": "Location"
        },
        {
          "type": "textarea",
          "id": "quote",
          "label": "Quote",
          "default": "I walk to quiet my mind"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link (optional)"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Stories carousel",
      "category": "t:categories.other"
    }
  ]
}
{% endschema %}
