{%- liquid
  assign show_eyebrow = section.settings.show_eyebrow
  assign show_heading = section.settings.show_heading
  assign show_description = section.settings.show_description
-%}

<div
  class="
    stories-section
    color-{{ section.settings.color_scheme }}
    {% render 'section-classes', settings: section.settings -%}
  "
  style="
    --stories-bg: {{ section.settings.background_color | default: '#F7F1E5' }};
    --stories-eyebrow-color: {{ section.settings.eyebrow_color | default: '#D14626' }};
    --stories-heading-color: {{ section.settings.heading_color | default: '#21262F' }};
    --stories-description-color: {{ section.settings.description_color | default: '#21262F' }};
    --stories-card-text-color: {{ section.settings.card_text_color | default: '#F7F1E5' }};
    --stories-nav-color: {{ section.settings.nav_color | default: '#21262F' }};
    --stories-track-color: {{ section.settings.nav_color | default: '#21262F' }};
  "
  {% if section.settings.enable_animations %}
    data-animate-elements-on-scroll
    data-animate-delay="125"
  {% endif %}
>
  <div class="stories-section__container page-width">
    <div class="stories-header {% if section.settings.enable_animations %}animate animate--slide-in{% endif %}">
      {%- if show_eyebrow and section.settings.eyebrow_text != blank -%}
        <p class="stories-header__eyebrow stories-header__eyebrow--{{ section.settings.eyebrow_style | default: 'stylized' }}">{{ section.settings.eyebrow_text }}</p>
      {%- endif -%}
      {%- if show_heading and section.settings.heading_text != blank -%}
        <h2 class="stories-header__title">{{ section.settings.heading_text | newline_to_br }}</h2>
      {%- endif -%}
      {%- if show_description and section.settings.description_text != blank -%}
        <p class="stories-header__description">{{ section.settings.description_text }}</p>
      {%- endif -%}
    </div>

    <div class="stories-carousel">
      <component-slider
        class="stories-carousel__slider swiper"
        data-mobile-columns="1.2"
        data-tablet-columns="2.5"
        data-desktop-columns="4"
        data-enable-loop="true"
        style="
          --mobile-columns: 1.2;
          --tablet-columns: 2.5;
          --desktop-columns: 4;
        "
      >
        <div class="stories-carousel__wrapper swiper-wrapper">
          {% for block in section.blocks %}
            {% if block.type == 'story_card' %}
              <div class="stories-carousel__slide swiper-slide" {{ block.shopify_attributes }}>
                {% render 'story-card',
                  image: block.settings.image,
                  name: block.settings.name,
                  location: block.settings.location,
                  quote: block.settings.quote,
                  link: block.settings.link,
                  animate: section.settings.enable_animations
                %}
              </div>
            {% elsif block.type == 'team_member' %}
              <div class="stories-carousel__slide stories-carousel__slide--team swiper-slide" {{ block.shopify_attributes }}>
                <div class="team-card {% if section.settings.enable_animations %}animate animate--slide-in{% endif %}">
                  <div class="team-card__image-wrapper">
                    {%- if block.settings.member_image != blank -%}
                      {% render 'image',
                        wrapper_class: 'team-card__image',
                        image: block.settings.member_image,
                        sizes: '(max-width: 749px) 280px, (max-width: 989px) 33vw, 320px',
                        aspect_ratio: '3-4',
                        no_radius: true
                      %}
                    {%- else -%}
                      <div class="team-card__image team-card__image--placeholder" style="--aspect-ratio: 3/4;">
                        {{ 'image' | placeholder_svg_tag: 'placeholder-svg' }}
                      </div>
                    {%- endif -%}
                  </div>
                  <div class="team-card__content">
                    {%- if block.settings.member_name != blank -%}
                      <p class="team-card__name">{{ block.settings.member_name | upcase }}</p>
                    {%- endif -%}
                    {%- if block.settings.member_title != blank -%}
                      <p class="team-card__title">{{ block.settings.member_title }}</p>
                    {%- endif -%}
                    {%- if block.settings.member_description != blank -%}
                      <p class="team-card__description">{{ block.settings.member_description }}</p>
                    {%- endif -%}
                  </div>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>

        <button type="button" class="stories-carousel__nav stories-carousel__nav--prev swiper-button-prev" aria-label="{{ 'general.slider.previous_slide' | t }}">
          <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" fill="none">
            <rect x="-0.5" y="0.5" width="29" height="29" rx="14.5" transform="matrix(-1 0 0 1 29 0)" stroke="currentColor" stroke-opacity="0.3"/>
            <path opacity="0.3" d="M21 15H9M9 15L15 9M9 15L15 21" stroke="currentColor"/>
          </svg>
        </button>
        <button type="button" class="stories-carousel__nav stories-carousel__nav--next swiper-button-next" aria-label="{{ 'general.slider.next_slide' | t }}">
          <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" fill="none">
            <rect x="0.5" y="0.5" width="29" height="29" rx="14.5" stroke="currentColor" stroke-opacity="0.3"/>
            <path opacity="0.3" d="M10 15H20M20 15L15 10M20 15L15 20" stroke="currentColor"/>
          </svg>
        </button>
      </component-slider>

      <div class="stories-footer">
        <div class="stories-footer__track">
          <div class="stories-footer__line"></div>
        </div>
        <div class="stories-footer__nav">
          <button type="button" class="stories-footer__btn stories-footer__btn--prev" aria-label="{{ 'general.slider.previous_slide' | t }}">
            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" fill="none">
              <rect x="-0.5" y="0.5" width="29" height="29" rx="14.5" transform="matrix(-1 0 0 1 29 0)" stroke="currentColor" stroke-opacity="0.3"/>
              <path opacity="0.3" d="M21 15H9M9 15L15 9M9 15L15 21" stroke="currentColor"/>
            </svg>
          </button>
          <button type="button" class="stories-footer__btn stories-footer__btn--next" aria-label="{{ 'general.slider.next_slide' | t }}">
            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" fill="none">
              <rect x="0.5" y="0.5" width="29" height="29" rx="14.5" stroke="currentColor" stroke-opacity="0.3"/>
              <path opacity="0.3" d="M10 15H20M20 15L15 10M20 15L15 20" stroke="currentColor"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const section = document.querySelector('.stories-section');
    if (!section) return;

    const prevBtn = section.querySelector('.stories-footer__btn--prev');
    const nextBtn = section.querySelector('.stories-footer__btn--next');
    const progressLine = section.querySelector('.stories-footer__line');
    const track = section.querySelector('.stories-footer__track');
    const slider = section.querySelector('component-slider');

    let currentIndex = 0;
    let totalSlides = 0;

    // Update progress line position
    function updateProgress() {
      if (!progressLine || !track || totalSlides === 0) return;
      const progress = totalSlides > 1 ? currentIndex / (totalSlides - 1) : 0;
      const trackWidth = track.offsetWidth;
      const lineWidth = progressLine.offsetWidth;
      const maxTranslate = trackWidth - lineWidth;
      const translateX = progress * maxTranslate;
      progressLine.style.transform = `translateX(${translateX}px)`;
    }

    // Navigate to next slide (with loop)
    function goNext() {
      if (!slider || !slider.swiper) return;
      slider.swiper.slideNext();
    }

    // Navigate to previous slide (with loop)
    function goPrev() {
      if (!slider || !slider.swiper) return;
      slider.swiper.slidePrev();
    }

    // Set up button listeners
    if (prevBtn) {
      prevBtn.addEventListener('click', goPrev);
    }
    if (nextBtn) {
      nextBtn.addEventListener('click', goNext);
    }

    // Wait for swiper to initialize
    const checkSwiper = setInterval(() => {
      if (slider && slider.swiper) {
        clearInterval(checkSwiper);
        // Count original slides only (not Swiper's loop duplicates)
        const originalSlides = section.querySelectorAll('.stories-carousel__slide');
        totalSlides = originalSlides.length;
        currentIndex = slider.swiper.realIndex || 0;

        // Get visible slides count from Swiper
        const visibleSlides = Math.floor(slider.swiper.params.slidesPerView);

        // Disable navigation if all slides are visible
        if (totalSlides <= visibleSlides) {
          if (prevBtn) {
            prevBtn.disabled = true;
            prevBtn.style.opacity = '0.3';
            prevBtn.style.cursor = 'default';
          }
          if (nextBtn) {
            nextBtn.disabled = true;
            nextBtn.style.opacity = '0.3';
            nextBtn.style.cursor = 'default';
          }
        }

        // Listen for slide changes (e.g., from touch/drag)
        slider.swiper.on('slideChange', () => {
          currentIndex = slider.swiper.realIndex || 0;
          updateProgress();
        });

        updateProgress();
      }
    }, 100);

    // Clear interval after 5 seconds to prevent infinite loop
    setTimeout(() => clearInterval(checkSwiper), 5000);
  });
</script>

{% schema %}
{
  "name": "t:sections.stories_carousel.name",
  "class": "stories-section-wrapper",
  "tag": "section",
  "disabled_on": {
    "groups": [
      "header",
      "footer"
    ],
    "templates": [
      "password"
    ]
  },
  "settings": [
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:sections.all.colors.label",
      "default": "scheme-1"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "t:sections.stories_carousel.settings.background_color.label",
      "default": "#F7F1E5"
    },
    {
      "type": "header",
      "content": "t:sections.stories_carousel.settings.header_content.content"
    },
    {
      "type": "checkbox",
      "id": "show_eyebrow",
      "label": "t:sections.stories_carousel.settings.show_eyebrow.label",
      "default": true
    },
    {
      "type": "text",
      "id": "eyebrow_text",
      "label": "t:sections.stories_carousel.settings.eyebrow_text.label",
      "default": "Stories"
    },
    {
      "type": "select",
      "id": "eyebrow_style",
      "label": "t:sections.stories_carousel.settings.eyebrow_style.label",
      "options": [
        {
          "value": "stylized",
          "label": "t:sections.stories_carousel.settings.eyebrow_style.option__stylized"
        },
        {
          "value": "small",
          "label": "t:sections.stories_carousel.settings.eyebrow_style.option__small"
        }
      ],
      "default": "stylized"
    },
    {
      "type": "color",
      "id": "eyebrow_color",
      "label": "t:sections.stories_carousel.settings.eyebrow_color.label",
      "default": "#E1E571"
    },
    {
      "type": "checkbox",
      "id": "show_heading",
      "label": "t:sections.stories_carousel.settings.show_heading.label",
      "default": true
    },
    {
      "type": "textarea",
      "id": "heading_text",
      "label": "t:sections.stories_carousel.settings.heading_text.label",
      "default": "FROM THE WALK"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "t:sections.stories_carousel.settings.heading_color.label",
      "default": "#21262F"
    },
    {
      "type": "checkbox",
      "id": "show_description",
      "label": "t:sections.stories_carousel.settings.show_description.label",
      "default": false
    },
    {
      "type": "textarea",
      "id": "description_text",
      "label": "t:sections.stories_carousel.settings.description_text.label"
    },
    {
      "type": "color",
      "id": "description_color",
      "label": "t:sections.stories_carousel.settings.description_color.label",
      "default": "#21262F"
    },
    {
      "type": "header",
      "content": "t:sections.stories_carousel.settings.header_cards.content"
    },
    {
      "type": "color",
      "id": "card_text_color",
      "label": "t:sections.stories_carousel.settings.card_text_color.label",
      "default": "#F7F1E5"
    },
    {
      "type": "color",
      "id": "nav_color",
      "label": "t:sections.stories_carousel.settings.nav_color.label",
      "default": "#21262F"
    },
    {
      "type": "header",
      "content": "t:common.header__section_spacing_and_border.content"
    },
    {
      "type": "select",
      "id": "section_spacing_top",
      "label": "t:common.top_spacing.label",
      "options": [
        {
          "value": "none",
          "label": "t:common.sizing.none"
        },
        {
          "value": "compact",
          "label": "t:common.sizing.compact"
        },
        {
          "value": "standard",
          "label": "t:common.sizing.standard"
        },
        {
          "value": "large",
          "label": "t:common.sizing.large"
        },
        {
          "value": "x-large",
          "label": "t:common.sizing.x_large"
        },
        {
          "value": "2x-large",
          "label": "t:common.sizing.x_x_large"
        }
      ],
      "default": "x-large"
    },
    {
      "type": "select",
      "id": "section_spacing_bottom",
      "label": "t:common.bottom_spacing.label",
      "options": [
        {
          "value": "none",
          "label": "t:common.sizing.none"
        },
        {
          "value": "compact",
          "label": "t:common.sizing.compact"
        },
        {
          "value": "standard",
          "label": "t:common.sizing.standard"
        },
        {
          "value": "large",
          "label": "t:common.sizing.large"
        },
        {
          "value": "x-large",
          "label": "t:common.sizing.x_large"
        },
        {
          "value": "2x-large",
          "label": "t:common.sizing.x_x_large"
        }
      ],
      "default": "x-large"
    },
    {
      "type": "checkbox",
      "id": "show_bottom_border",
      "label": "t:common.show_bottom_border.label",
      "default": false
    },
    {
      "type": "header",
      "content": "t:common.header__section_animations.content"
    },
    {
      "type": "checkbox",
      "id": "enable_animations",
      "label": "t:common.enable_animations.label",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "story_card",
      "name": "t:sections.stories_carousel.blocks.story_card.name",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "t:sections.stories_carousel.blocks.story_card.settings.image.label"
        },
        {
          "type": "text",
          "id": "name",
          "label": "t:sections.stories_carousel.blocks.story_card.settings.name.label",
          "default": "Name"
        },
        {
          "type": "text",
          "id": "location",
          "label": "t:sections.stories_carousel.blocks.story_card.settings.location.label",
          "default": "Location"
        },
        {
          "type": "textarea",
          "id": "quote",
          "label": "t:sections.stories_carousel.blocks.story_card.settings.quote.label",
          "default": "I walk to quiet my mind"
        },
        {
          "type": "url",
          "id": "link",
          "label": "t:sections.stories_carousel.blocks.story_card.settings.link.label"
        }
      ]
    },
    {
      "type": "team_member",
      "name": "t:sections.stories_carousel.blocks.team_member.name",
      "settings": [
        {
          "type": "image_picker",
          "id": "member_image",
          "label": "t:sections.stories_carousel.blocks.team_member.settings.image.label"
        },
        {
          "type": "text",
          "id": "member_name",
          "label": "t:sections.stories_carousel.blocks.team_member.settings.name.label",
          "default": "Dr. Jane Smith"
        },
        {
          "type": "text",
          "id": "member_title",
          "label": "t:sections.stories_carousel.blocks.team_member.settings.title.label",
          "default": "Neuroscientist"
        },
        {
          "type": "textarea",
          "id": "member_description",
          "label": "t:sections.stories_carousel.blocks.team_member.settings.description.label",
          "default": "The science of motion and mental clarity"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "t:sections.stories_carousel.presets.name",
      "category": "t:categories.other",
      "settings": {
        "background_color": "#F7F1E5",
        "show_eyebrow": true,
        "eyebrow_text": "Stories",
        "eyebrow_style": "stylized",
        "eyebrow_color": "#D14626",
        "show_heading": true,
        "heading_text": "FROM THE WALK",
        "heading_color": "#21262F",
        "show_description": false,
        "description_color": "#21262F",
        "card_text_color": "#F7F1E5",
        "nav_color": "#21262F"
      }
    }
  ]
}
{% endschema %}
