{%- liquid
  assign product_1 = section.settings.product_1
  assign product_2 = section.settings.product_2

  # Product 1 media assignments
  assign p1_desktop_video = section.settings.product_1_desktop_video
  assign p1_desktop_image = section.settings.product_1_desktop_image
  if p1_desktop_image == blank and product_1 != blank
    assign p1_desktop_image = product_1.featured_image
  endif
  assign p1_mobile_video = section.settings.product_1_mobile_video
  assign p1_mobile_image = section.settings.product_1_mobile_image

  assign p1_has_desktop_video = false
  if p1_desktop_video != blank
    assign p1_has_desktop_video = true
  endif

  assign p1_has_mobile_video = false
  if p1_mobile_video != blank
    assign p1_has_mobile_video = true
  endif

  # Product 2 media assignments
  assign p2_desktop_video = section.settings.product_2_desktop_video
  assign p2_desktop_image = section.settings.product_2_desktop_image
  if p2_desktop_image == blank and product_2 != blank
    assign p2_desktop_image = product_2.featured_image
  endif
  assign p2_mobile_video = section.settings.product_2_mobile_video
  assign p2_mobile_image = section.settings.product_2_mobile_image

  assign p2_has_desktop_video = false
  if p2_desktop_video != blank
    assign p2_has_desktop_video = true
  endif

  assign p2_has_mobile_video = false
  if p2_mobile_video != blank
    assign p2_has_mobile_video = true
  endif
-%}

<div
  class="
    product-showcase
    section
    color-{{ section.settings.color_scheme }}
  "
  data-section-id="{{ section.id }}"
  {% if section.settings.enable_animations %}
    data-animate-elements-on-scroll
    data-animate-delay="125"
  {% endif %}
>
  <div class="product-showcase__inner">
    {%- comment -%} Header Section {%- endcomment -%}
    {% if section.settings.heading != blank or section.settings.subtitle != blank %}
      <div class="product-showcase__header {% if section.settings.enable_animations %}animate animate--slide-in{% endif %}">
        {% if section.settings.heading != blank %}
          <h2 class="product-showcase__heading">{{ section.settings.heading }}</h2>
        {% endif %}
        {% if section.settings.subtitle != blank %}
          <p class="product-showcase__subtitle">{{ section.settings.subtitle }}</p>
        {% endif %}
      </div>
    {% endif %}

    {%- comment -%} Product Cards Container {%- endcomment -%}
    <div class="product-showcase__cards">
      {%- comment -%} Product Card 1 {%- endcomment -%}
      {% if product_1 != blank %}
        <a href="{{ product_1.url }}" class="product-showcase__card {% if section.settings.enable_animations %}animate animate--slide-in{% endif %}">
          <div class="product-showcase__card-inner">
            {%- comment -%} Full-bleed Product Media {%- endcomment -%}
            {%- comment -%} Desktop Media {%- endcomment -%}
            <div class="product-showcase__card-media product-showcase__card-media--desktop">
              {% if p1_has_desktop_video %}
                <video
                  class="product-showcase__video"
                  aria-label="{{ product_1.title | strip_html | escape }} product video"
                  autoplay
                  muted
                  loop
                  playsinline
                  preload="metadata"
                  {% if p1_desktop_image != blank %}
                    poster="{{ p1_desktop_image | image_url: width: 1920 }}"
                  {% endif %}
                >
                  {% for source in p1_desktop_video.sources %}
                    {% if source.mime_type == 'video/webm' %}
                      <source src="{{ source.url }}" type="{{ source.mime_type }}">
                    {% endif %}
                  {% endfor %}
                  {% for source in p1_desktop_video.sources %}
                    {% if source.mime_type == 'video/mp4' %}
                      <source src="{{ source.url }}" type="{{ source.mime_type }}">
                    {% endif %}
                  {% endfor %}
                </video>
              {% elsif p1_desktop_image != blank %}
                {% render 'image',
                  image: p1_desktop_image,
                  sizes: '(max-width: 749px) 50vw, 50vw',
                  no_radius: true
                %}
              {% else %}
                <div class="product-showcase__image-placeholder">
                  {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                </div>
              {% endif %}
            </div>

            {%- comment -%} Mobile Media {%- endcomment -%}
            <div class="product-showcase__card-media product-showcase__card-media--mobile">
              {% if p1_has_mobile_video %}
                <video
                  class="product-showcase__video"
                  aria-label="{{ product_1.title | strip_html | escape }} product video"
                  autoplay
                  muted
                  loop
                  playsinline
                  preload="metadata"
                  {% if p1_mobile_image != blank %}
                    poster="{{ p1_mobile_image | image_url: width: 1920 }}"
                  {% elsif p1_desktop_image != blank %}
                    poster="{{ p1_desktop_image | image_url: width: 1920 }}"
                  {% endif %}
                >
                  {% for source in p1_mobile_video.sources %}
                    {% if source.mime_type == 'video/webm' %}
                      <source src="{{ source.url }}" type="{{ source.mime_type }}">
                    {% endif %}
                  {% endfor %}
                  {% for source in p1_mobile_video.sources %}
                    {% if source.mime_type == 'video/mp4' %}
                      <source src="{{ source.url }}" type="{{ source.mime_type }}">
                    {% endif %}
                  {% endfor %}
                </video>
              {% elsif p1_mobile_image != blank %}
                {% render 'image',
                  image: p1_mobile_image,
                  sizes: '(max-width: 749px) 50vw, 50vw',
                  no_radius: true
                %}
              {% elsif p1_has_desktop_video %}
                <video
                  class="product-showcase__video"
                  aria-label="{{ product_1.title | strip_html | escape }} product video"
                  autoplay
                  muted
                  loop
                  playsinline
                  preload="metadata"
                  {% if p1_desktop_image != blank %}
                    poster="{{ p1_desktop_image | image_url: width: 1920 }}"
                  {% endif %}
                >
                  {% for source in p1_desktop_video.sources %}
                    {% if source.mime_type == 'video/webm' %}
                      <source src="{{ source.url }}" type="{{ source.mime_type }}">
                    {% endif %}
                  {% endfor %}
                  {% for source in p1_desktop_video.sources %}
                    {% if source.mime_type == 'video/mp4' %}
                      <source src="{{ source.url }}" type="{{ source.mime_type }}">
                    {% endif %}
                  {% endfor %}
                </video>
              {% elsif p1_desktop_image != blank %}
                {% render 'image',
                  image: p1_desktop_image,
                  sizes: '(max-width: 749px) 50vw, 50vw',
                  no_radius: true
                %}
              {% else %}
                <div class="product-showcase__image-placeholder">
                  {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                </div>
              {% endif %}
            </div>

            {%- comment -%} Gradient Overlay for readability {%- endcomment -%}
            <div class="product-showcase__card-overlay"></div>

            {%- comment -%} Text Content Overlaid at Bottom {%- endcomment -%}
            <div class="product-showcase__card-content">
              <h3 class="product-showcase__card-title">{{ product_1.title }}</h3>
              {% assign short_desc_1 = product_1.metafields.custom.short_description %}
              {% if short_desc_1 != blank %}
                <p class="product-showcase__card-description">{{ short_desc_1 }}</p>
              {% endif %}
              <span class="product-showcase__card-link">
                {{ section.settings.link_text | default: 'Discover now' }}
              </span>
            </div>
          </div>
        </a>
      {% else %}
        {%- comment -%} Placeholder Card 1 {%- endcomment -%}
        <div class="product-showcase__card product-showcase__card--placeholder {% if section.settings.enable_animations %}animate animate--slide-in{% endif %}">
          <div class="product-showcase__card-inner">
            <div class="product-showcase__card-media">
              <div class="product-showcase__image-placeholder">
                {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
              </div>
            </div>
            <div class="product-showcase__card-overlay"></div>
            <div class="product-showcase__card-content">
              <h3 class="product-showcase__card-title">Product Title</h3>
              <p class="product-showcase__card-description">Select a product to display</p>
              <span class="product-showcase__card-link">{{ section.settings.link_text | default: 'Discover now' }}</span>
            </div>
          </div>
        </div>
      {% endif %}

      {%- comment -%} Product Card 2 {%- endcomment -%}
      {% if product_2 != blank %}
        <a href="{{ product_2.url }}" class="product-showcase__card {% if section.settings.enable_animations %}animate animate--slide-in{% endif %}">
          <div class="product-showcase__card-inner">
            {%- comment -%} Desktop Media {%- endcomment -%}
            <div class="product-showcase__card-media product-showcase__card-media--desktop">
              {% if p2_has_desktop_video %}
                <video
                  class="product-showcase__video"
                  aria-label="{{ product_2.title | strip_html | escape }} product video"
                  autoplay
                  muted
                  loop
                  playsinline
                  preload="metadata"
                  {% if p2_desktop_image != blank %}
                    poster="{{ p2_desktop_image | image_url: width: 1920 }}"
                  {% endif %}
                >
                  {% for source in p2_desktop_video.sources %}
                    {% if source.mime_type == 'video/webm' %}
                      <source src="{{ source.url }}" type="{{ source.mime_type }}">
                    {% endif %}
                  {% endfor %}
                  {% for source in p2_desktop_video.sources %}
                    {% if source.mime_type == 'video/mp4' %}
                      <source src="{{ source.url }}" type="{{ source.mime_type }}">
                    {% endif %}
                  {% endfor %}
                </video>
              {% elsif p2_desktop_image != blank %}
                {% render 'image',
                  image: p2_desktop_image,
                  sizes: '(max-width: 749px) 50vw, 50vw',
                  no_radius: true
                %}
              {% else %}
                <div class="product-showcase__image-placeholder">
                  {{ 'product-2' | placeholder_svg_tag: 'placeholder-svg' }}
                </div>
              {% endif %}
            </div>

            {%- comment -%} Mobile Media {%- endcomment -%}
            <div class="product-showcase__card-media product-showcase__card-media--mobile">
              {% if p2_has_mobile_video %}
                <video
                  class="product-showcase__video"
                  aria-label="{{ product_2.title | strip_html | escape }} product video"
                  autoplay
                  muted
                  loop
                  playsinline
                  preload="metadata"
                  {% if p2_mobile_image != blank %}
                    poster="{{ p2_mobile_image | image_url: width: 1920 }}"
                  {% elsif p2_desktop_image != blank %}
                    poster="{{ p2_desktop_image | image_url: width: 1920 }}"
                  {% endif %}
                >
                  {% for source in p2_mobile_video.sources %}
                    {% if source.mime_type == 'video/webm' %}
                      <source src="{{ source.url }}" type="{{ source.mime_type }}">
                    {% endif %}
                  {% endfor %}
                  {% for source in p2_mobile_video.sources %}
                    {% if source.mime_type == 'video/mp4' %}
                      <source src="{{ source.url }}" type="{{ source.mime_type }}">
                    {% endif %}
                  {% endfor %}
                </video>
              {% elsif p2_mobile_image != blank %}
                {% render 'image',
                  image: p2_mobile_image,
                  sizes: '(max-width: 749px) 50vw, 50vw',
                  no_radius: true
                %}
              {% elsif p2_has_desktop_video %}
                <video
                  class="product-showcase__video"
                  aria-label="{{ product_2.title | strip_html | escape }} product video"
                  autoplay
                  muted
                  loop
                  playsinline
                  preload="metadata"
                  {% if p2_desktop_image != blank %}
                    poster="{{ p2_desktop_image | image_url: width: 1920 }}"
                  {% endif %}
                >
                  {% for source in p2_desktop_video.sources %}
                    {% if source.mime_type == 'video/webm' %}
                      <source src="{{ source.url }}" type="{{ source.mime_type }}">
                    {% endif %}
                  {% endfor %}
                  {% for source in p2_desktop_video.sources %}
                    {% if source.mime_type == 'video/mp4' %}
                      <source src="{{ source.url }}" type="{{ source.mime_type }}">
                    {% endif %}
                  {% endfor %}
                </video>
              {% elsif p2_desktop_image != blank %}
                {% render 'image',
                  image: p2_desktop_image,
                  sizes: '(max-width: 749px) 50vw, 50vw',
                  no_radius: true
                %}
              {% else %}
                <div class="product-showcase__image-placeholder">
                  {{ 'product-2' | placeholder_svg_tag: 'placeholder-svg' }}
                </div>
              {% endif %}
            </div>
            <div class="product-showcase__card-overlay"></div>
            <div class="product-showcase__card-content">
              <h3 class="product-showcase__card-title">{{ product_2.title }}</h3>
              {% assign short_desc_2 = product_2.metafields.custom.short_description %}
              {% if short_desc_2 != blank %}
                <p class="product-showcase__card-description">{{ short_desc_2 }}</p>
              {% endif %}
              <span class="product-showcase__card-link">
                {{ section.settings.link_text | default: 'Discover now' }}
              </span>
            </div>
          </div>
        </a>
      {% else %}
        {%- comment -%} Placeholder Card 2 {%- endcomment -%}
        <div class="product-showcase__card product-showcase__card--placeholder {% if section.settings.enable_animations %}animate animate--slide-in{% endif %}">
          <div class="product-showcase__card-inner">
            <div class="product-showcase__card-media">
              <div class="product-showcase__image-placeholder">
                {{ 'product-2' | placeholder_svg_tag: 'placeholder-svg' }}
              </div>
            </div>
            <div class="product-showcase__card-overlay"></div>
            <div class="product-showcase__card-content">
              <h3 class="product-showcase__card-title">Product Title</h3>
              <p class="product-showcase__card-description">Select a product to display</p>
              <span class="product-showcase__card-link">{{ section.settings.link_text | default: 'Discover now' }}</span>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>

{% if p1_has_desktop_video or p1_has_mobile_video or p2_has_desktop_video or p2_has_mobile_video %}
<script>
  (function() {
    const videos = document.querySelectorAll('[data-section-id="{{ section.id }}"] .product-showcase__video');
    if (!videos.length) return;

    videos.forEach(function(video) {
      // Show video once it can play
      function onVideoReady() {
        video.classList.add('is-loaded');
      }

      // Check if video is already ready
      if (video.readyState >= 3) {
        onVideoReady();
      } else {
        video.addEventListener('canplay', onVideoReady, { once: true });
      }

      // Fallback: show video after timeout even if not fully loaded
      setTimeout(function() {
        if (!video.classList.contains('is-loaded')) {
          video.classList.add('is-loaded');
        }
      }, 3000);

      // Try to play video (handles autoplay restrictions)
      video.play().catch(function() {
        // Autoplay blocked, video will still show with poster
        video.classList.add('is-loaded');
      });
    });
  })();
</script>
{% endif %}

<style>
  .product-showcase__card-media {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

  .product-showcase__card-media--mobile {
    display: none;
  }

  .product-showcase__card-media--desktop {
    display: block;
  }

  @media screen and (max-width: 990px) {
    .product-showcase__card-media--mobile {
      display: block;
    }

    .product-showcase__card-media--desktop {
      display: none;
    }
  }

  .product-showcase__video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0;
    transition: opacity 0.5s ease;
  }

  .product-showcase__video.is-loaded {
    opacity: 1;
  }
</style>

{% schema %}
{
  "name": "Product Showcase",
  "class": "product-showcase-section",
  "tag": "section",
  "disabled_on": {
    "groups": ["header", "footer"],
    "templates": ["password"]
  },
  "settings": [
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:sections.all.colors.label",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "Header"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "WALKING ESSENTIALS"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtitle",
      "default": "Coming soon",
      "info": "Displayed in italic accent font style"
    },
    {
      "type": "header",
      "content": "Product 1"
    },
    {
      "type": "product",
      "id": "product_1",
      "label": "First product"
    },
    {
      "type": "header",
      "content": "Product 1 Custom Media"
    },
    {
      "type": "image_picker",
      "id": "product_1_desktop_image",
      "label": "Custom desktop image",
      "info": "Optional: Override product featured image"
    },
    {
      "type": "video",
      "id": "product_1_desktop_video",
      "label": "Desktop video",
      "info": "If provided, will be used instead of image"
    },
    {
      "type": "image_picker",
      "id": "product_1_mobile_image",
      "label": "Custom mobile image",
      "info": "Optional: Different image for mobile"
    },
    {
      "type": "video",
      "id": "product_1_mobile_video",
      "label": "Mobile video"
    },
    {
      "type": "header",
      "content": "Product 2"
    },
    {
      "type": "product",
      "id": "product_2",
      "label": "Second product"
    },
    {
      "type": "header",
      "content": "Product 2 Custom Media"
    },
    {
      "type": "image_picker",
      "id": "product_2_desktop_image",
      "label": "Custom desktop image",
      "info": "Optional: Override product featured image"
    },
    {
      "type": "video",
      "id": "product_2_desktop_video",
      "label": "Desktop video",
      "info": "If provided, will be used instead of image"
    },
    {
      "type": "image_picker",
      "id": "product_2_mobile_image",
      "label": "Custom mobile image",
      "info": "Optional: Different image for mobile"
    },
    {
      "type": "video",
      "id": "product_2_mobile_video",
      "label": "Mobile video"
    },
    {
      "type": "header",
      "content": "Card Settings"
    },
    {
      "type": "text",
      "id": "link_text",
      "label": "Link text",
      "default": "Discover now"
    },
    {
      "type": "header",
      "content": "t:common.header__section_animations.content"
    },
    {
      "type": "checkbox",
      "id": "enable_animations",
      "label": "t:common.enable_animations.label",
      "default": true
    }
  ],
  "presets": [
    {
      "name": "Product Showcase"
    }
  ]
}
{% endschema %}
